-- DB update 2021_11_06_00 -> 2022_01_23_00
DROP PROCEDURE IF EXISTS `updateDb`;
DELIMITER //
CREATE PROCEDURE updateDb ()
proc:BEGIN DECLARE OK VARCHAR(100) DEFAULT 'FALSE';
SELECT COUNT(*) INTO @COLEXISTS
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME = 'version_db_auth' AND COLUMN_NAME = '2021_11_06_00';
IF @COLEXISTS = 0 THEN LEAVE proc; END IF;
START TRANSACTION;
ALTER TABLE version_db_auth CHANGE COLUMN 2021_11_06_00 2022_01_23_00 bit;
SELECT sql_rev INTO OK FROM version_db_auth WHERE sql_rev = '1642788297640968600'; IF OK <> 'FALSE' THEN LEAVE proc; END IF;
--
-- START UPDATING QUERIES
--

--
-- Fixed updates
--

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

-- Дамп структуры для таблица test_acore_auth.version_db_auth
DROP TABLE IF EXISTS `version_db_auth`;
CREATE TABLE IF NOT EXISTS `version_db_auth` (
  `sql_rev` varchar(100) NOT NULL,
  `required_rev` varchar(100) DEFAULT NULL,
  `date` varchar(50) DEFAULT NULL,
  `2022_01_23_00` bit(1) DEFAULT NULL,
  PRIMARY KEY (`sql_rev`),
  KEY `required` (`required_rev`),
  CONSTRAINT `required` FOREIGN KEY (`required_rev`) REFERENCES `version_db_auth` (`sql_rev`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT='Last applied sql update to DB';

-- Дамп данных таблицы test_acore_auth.version_db_auth: ~11 rows (приблизительно)
DELETE FROM `version_db_auth`;
/*!40000 ALTER TABLE `version_db_auth` DISABLE KEYS */;
INSERT INTO `version_db_auth` (`sql_rev`, `required_rev`, `date`, `2022_01_23_00`) VALUES
	('1554142988374631100', NULL, NULL, NULL),
	('1579213352894781043', NULL, NULL, NULL),
	('1609867708436603000', NULL, NULL, NULL),
	('1615629613255169700', NULL, NULL, NULL),
	('1620079951672711500', NULL, NULL, NULL),
	('1620114805872279900', NULL, NULL, NULL),
	('1620146306002634000', NULL, '2021_06_17_00', NULL),
	('1621715473238990700', NULL, '2021_05_30_00', NULL),
	('1634163668021762900', NULL, '2021_10_14_00', NULL),
	('1635587640506554000', NULL, '2021_11_06_00', NULL),
	('1642788297640968600', NULL, '2022_01_23_00', NULL);
/*!40000 ALTER TABLE `version_db_auth` ENABLE KEYS */;

/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;

-- ACDB 335.6-dev auth
UPDATE `updates` SET `state`='ARCHIVED';

--
-- END UPDATING QUERIES
--
UPDATE version_db_auth SET date = '2022_01_23_00' WHERE sql_rev = '1642788297640968600';
COMMIT;
END //
DELIMITER ;
CALL updateDb();
DROP PROCEDURE IF EXISTS `updateDb`;
